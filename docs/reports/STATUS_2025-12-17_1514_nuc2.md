# STATUS 2025-12-17 15:14 UTC — NUC2 baseline check

## Summary
Baseline sanity for Docker Compose stack (db, admin-api, web, admin-ui), port `3080` collision status, and env health (presence-only; no secret values).

## A) Initialize (host/repo metadata)
Commands + outputs:

```bash
date
```
```text
2025-12-17 15:14:34 UTC
```

```bash
hostname
```
```text
slimy-nuc2
```

```bash
pwd
```
```text
/opt/slimy/slimy-monorepo
```

```bash
git rev-parse --abbrev-ref HEAD
```
```text
nuc2/verify-role-b33e616
```

```bash
git status -sb
```
```text
## nuc2/verify-role-b33e616
 M .gitignore
 M apps/admin-api/.env.admin
 M apps/admin-api/.env.local
 M apps/admin-api/src/routes/discord.js
 M apps/admin-api/src/routes/guilds.js
 M apps/web/app/(marketing)/components/CTA.tsx
 M apps/web/app/(marketing)/components/ChatWidget.simple.bak
 M apps/web/app/(marketing)/components/Nav.tsx
 M apps/web/components/auth/login-button.tsx
 M docker-compose.yml
 M package.json
 M scripts/dev/migrate-admin-api-db.sh
 M scripts/smoke/docker-smoke.sh
?? apps/admin-api/tests/discord-guilds.test.js
?? apps/admin-api/tests/guild-connect.test.js
?? config/
?? docs/buglog/BUG_2025-12-14_guilds-filter-user-intersect-slimyai-bot.md
?? docs/buglog/BUG_2025-12-14_guilds-owned-visible_connect-shared-only.md
?? docs/buglog/BUG_2025-12-17_port-3080-collision-and-slimyai-bot-token.md
?? scripts/env-check.ts
?? scripts/env-sync.ts
```

## B) Quick repo sanity (no secrets)

```bash
git diff --name-only
```
```text
.gitignore
apps/admin-api/.env.admin
apps/admin-api/.env.local
apps/admin-api/src/routes/discord.js
apps/admin-api/src/routes/guilds.js
apps/web/app/(marketing)/components/CTA.tsx
apps/web/app/(marketing)/components/ChatWidget.simple.bak
apps/web/app/(marketing)/components/Nav.tsx
apps/web/components/auth/login-button.tsx
docker-compose.yml
package.json
scripts/dev/migrate-admin-api-db.sh
scripts/smoke/docker-smoke.sh
```

```bash
rg -n "ADMIN_API_INTERNAL_URL" docker-compose.yml || true
```
```text
102:      ADMIN_API_INTERNAL_URL: "http://admin-api:3080"
122:        ADMIN_API_INTERNAL_URL: "http://admin-api:3080"
132:      ADMIN_API_INTERNAL_URL: "http://admin-api:3080"
```

To avoid leaking secrets, use filename-only search when scanning `.env*` files.

```bash
rg --files-with-matches "SLIMYAI_BOT_TOKEN" .env* docker-compose.yml apps scripts config docs || true
```
```text
docs/buglog/BUG_2025-12-17_port-3080-collision-and-slimyai-bot-token.md
config/env.schema.json
.env.local
docs/buglog/BUG_2025-12-14_guilds-filter-user-intersect-slimyai-bot.md
docker-compose.yml
docs/buglog/BUG_2025-12-14_guilds-owned-visible_connect-shared-only.md
apps/admin-api/src/routes/guilds.js
apps/admin-api/src/routes/discord.js
apps/admin-api/tests/guild-connect.test.js
apps/admin-api/tests/discord-guilds.test.js
```

```bash
rg -n "SLIMYAI_BOT_TOKEN" docker-compose.yml scripts || true
```
```text
docker-compose.yml:41:      SLIMYAI_BOT_TOKEN: ${SLIMYAI_BOT_TOKEN:-}
```

## C) Port + container collision checks

```bash
sudo -n ss -ltnp 2>&1 | grep ':3080' || echo "3080 free (no host listener)"
```
```text
NOTE: Ran as `sudo -n` (non-interactive); output was not authoritative without an active sudo session.
3080 free (no host listener)
```

```bash
ss -ltnp | grep ':3080' || true
```
```text
LISTEN 0      4096         0.0.0.0:3080       0.0.0.0:*
LISTEN 0      4096            [::]:3080          [::]:*
```

```bash
docker ps --format 'table {{.Names}}\t{{.Ports}}' | rg '3080' || echo "No running containers publishing 3080"
```
```text
slimy-monorepo-admin-api-1   0.0.0.0:3080->3080/tcp, [::]:3080->3080/tcp
```

```bash
docker ps -a --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}' | rg '3080|slimy-admin-api|admin-api' || true
```
```text
slimy-admin-api              Created
slimy-monorepo-admin-api-1   Up 16 minutes (healthy)    0.0.0.0:3080->3080/tcp, [::]:3080->3080/tcp
```

## D) Env health checks (no values)

```bash
pnpm env:check
```
```text
> slimy-monorepo@ env:check /opt/slimy/slimy-monorepo
> tsx scripts/env-check.ts

env:check OK (3 required keys present; no values printed).
```

```bash
grep -q '^DISCORD_BOT_TOKEN=' .env.local && echo "DISCORD_BOT_TOKEN present" || echo "DISCORD_BOT_TOKEN missing"
```
```text
DISCORD_BOT_TOKEN present
```

```bash
grep -q '^SLIMYAI_BOT_TOKEN=' .env.local && echo "SLIMYAI_BOT_TOKEN present" || echo "SLIMYAI_BOT_TOKEN missing"
```
```text
SLIMYAI_BOT_TOKEN present
```

## E) Compose baseline health

```bash
pnpm smoke:docker
```
First attempt failed due to port collision:
```text
Error response from daemon: failed to set up container networking: driver failed programming external connectivity on endpoint slimy-monorepo-admin-api-1 (...): Bind for 0.0.0.0:3080 failed: port is already allocated
```

Remediation (no secret values printed):
```bash
docker ps --filter "publish=3080" --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}' || true
docker stop slimy-admin-api && docker update --restart=no slimy-admin-api
```
```text
NAMES             IMAGE                  STATUS                        PORTS
slimy-admin-api   slimy-nuc2-admin-api   Up About a minute (healthy)   0.0.0.0:3080->3080/tcp, [::]:3080->3080/tcp
```

Re-run:
```bash
pnpm smoke:docker
```
```text
PASS: Docker baseline smoke test
```

```bash
docker compose ps
```
```text
NAME                         IMAGE                      COMMAND                  SERVICE     CREATED              STATUS                        PORTS
slimy-monorepo-admin-api-1   slimy-monorepo-admin-api   "docker-entrypoint.s…"   admin-api   About a minute ago   Up About a minute (healthy)   0.0.0.0:3080->3080/tcp, :::3080->3080/tcp
slimy-monorepo-admin-ui-1    slimy-monorepo-admin-ui    "docker-entrypoint.s…"   admin-ui    About a minute ago   Up About a minute             0.0.0.0:3001->3000/tcp, :::3001->3000/tcp
slimy-monorepo-db-1          mysql:8.0                  "docker-entrypoint.s…"   db          About a minute ago   Up About a minute (healthy)   3306/tcp, 33060/tcp
slimy-monorepo-web-1         slimy-monorepo-web         "docker-entrypoint.s…"   web         About a minute ago   Up About a minute             0.0.0.0:3000->3000/tcp, :::3000->3000/tcp
```

```bash
curl -sS -i http://localhost:3080/api/health | sed -n '1,25p'
```
```text
HTTP/1.1 200 OK
Content-Security-Policy: default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';img-src 'self' data:;object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline';upgrade-insecure-requests
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Resource-Policy: same-origin
Origin-Agent-Cluster: ?1
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-DNS-Prefetch-Control: off
X-Download-Options: noopen
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
X-XSS-Protection: 0
X-Request-ID: 63458f51-0500-4c65-a9d4-00b394127aa4
Access-Control-Allow-Origin: http://localhost:3000
Vary: Origin
Access-Control-Allow-Credentials: true
Cache-Control: no-store
Content-Type: application/json; charset=utf-8
Content-Length: 84
Date: Wed, 17 Dec 2025 15:19:54 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"status":"ok","uptime":14,"timestamp":"2025-12-17T15:19:54.367Z","version":"1.0.0"}
```

## F) Minimal API shape checks (no auth required)
To avoid printing cookies, redact any `Set-Cookie:` headers (none observed in these responses).

```bash
curl -sS -i http://localhost:3080/api/auth/me | sed -n '1,25p' | sed -E 's/^(Set-Cookie:).*/\\1 [REDACTED]/I'
```
```text
HTTP/1.1 401 Unauthorized
Content-Security-Policy: default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';img-src 'self' data:;object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline';upgrade-insecure-requests
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Resource-Policy: same-origin
Origin-Agent-Cluster: ?1
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-DNS-Prefetch-Control: off
X-Download-Options: noopen
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
X-XSS-Protection: 0
X-Request-ID: 6cc682c2-2869-4534-84fb-930bff3a2b1e
Access-Control-Allow-Origin: http://localhost:3000
Vary: Origin
Access-Control-Allow-Credentials: true
Cache-Control: no-store
Content-Type: application/json; charset=utf-8
Content-Length: 24
Date: Wed, 17 Dec 2025 15:21:24 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"error":"unauthorized"}
```

```bash
curl -sS -i http://localhost:3080/api/guilds | sed -n '1,25p' | sed -E 's/^(Set-Cookie:).*/\\1 [REDACTED]/I'
```
```text
HTTP/1.1 401 Unauthorized
Content-Security-Policy: default-src 'self';base-uri 'self';font-src 'self' https: data:;form-action 'self';frame-ancestors 'self';img-src 'self' data:;object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline';upgrade-insecure-requests
Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Resource-Policy: same-origin
Origin-Agent-Cluster: ?1
Referrer-Policy: no-referrer
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-DNS-Prefetch-Control: off
X-Download-Options: noopen
X-Frame-Options: SAMEORIGIN
X-Permitted-Cross-Domain-Policies: none
X-XSS-Protection: 0
X-Request-ID: 3453190d-4882-4cb9-a22d-49a84ffe0d61
Access-Control-Allow-Origin: http://localhost:3000
Vary: Origin
Access-Control-Allow-Credentials: true
Cache-Control: no-store
Content-Type: application/json; charset=utf-8
Content-Length: 70
Date: Wed, 17 Dec 2025 15:21:24 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"ok":false,"code":"UNAUTHORIZED","message":"Authentication required"}
```

## G) Pick up from here

### Baseline PASS criteria
- `pnpm smoke:docker`: PASS (after stopping legacy `slimy-admin-api` container binding `3080`)
- `docker compose ps`: all services running/healthy
- `GET /api/health`: HTTP 200
- Port `3080`: no collision after remediation
- `SLIMYAI_BOT_TOKEN`: present (checked presence-only)

### Decision
- BASELINE PASS ✅
- Next plan step: Step 1 — Fix `/api/guilds` to return `(user guilds ∩ SlimyAI bot guilds)` + role labels (do not start until legacy port binders are permanently disabled).
