name: slimy-nuc2

services:
  slimy-db:
    image: mysql:8
    container_name: slimy-db
    restart: unless-stopped
    env_file:
      - /opt/slimy/secrets/.env.db.slimy-nuc2
    ports:
      - "3306:3306"
    volumes:
      - slimy-db-data:/var/lib/mysql
      - /opt/slimy/backups/mysql:/backups
    healthcheck:
      test:
        - CMD-SHELL
        - mysqladmin ping -p"$$MYSQL_ROOT_PASSWORD" >/dev/null 2>&1
      interval: 10s
      timeout: 5s
      retries: 30
    networks:
      - slimy

  admin-api:
    build:
      context: ../..
      dockerfile: apps/admin-api/Dockerfile
    container_name: slimy-admin-api
    restart: unless-stopped
    env_file:
      - /opt/slimy/secrets/.env.admin.production
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 3080
      TRUST_PROXY: "1"
      UPLOADS_DIR: /var/lib/slimy/uploads
      BACKUP_ROOT: /var/backups/slimy
      BACKUP_MYSQL_DIR: /var/backups/slimy/mysql
      BACKUP_DATA_DIR: /var/backups/slimy/data
      CORS_ORIGIN: https://admin.slimyai.xyz
      # NUC2 dev environment - dummy credentials for local testing
      DISCORD_CLIENT_ID: "123456789012345678"
      DISCORD_CLIENT_SECRET: "test_secret_for_nuc2_development_only"
      SESSION_SECRET: "test_session_secret_for_nuc2_development_only"
    depends_on:
      slimy-db:
        condition: service_healthy
    ports:
      - "3080:3080"
    volumes:
      - /opt/slimy/data/admin-api/data:/app/data
      - /opt/slimy/data/admin-api/uploads:/var/lib/slimy/uploads
      - /opt/slimy/backups/admin-api:/var/backups/slimy
      - /opt/slimy/logs/admin-api:/app/logs
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          node -e "require('http').get('http://127.0.0.1:3080/api/health',
          res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error',
          () => process.exit(1));"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - slimy

  web:
    build:
      context: ../..
      dockerfile: apps/web/Dockerfile
      args:
        NEXT_PUBLIC_ADMIN_API_BASE: ${NEXT_PUBLIC_ADMIN_API_BASE:-https://admin.slimyai.xyz}
        NEXT_PUBLIC_SNELP_CODES_URL: ${NEXT_PUBLIC_SNELP_CODES_URL:-https://www.snelp.com/codes/codes.json}
        NEXT_PUBLIC_PLAUSIBLE_DOMAIN: ${NEXT_PUBLIC_PLAUSIBLE_DOMAIN:-slimy.ai}
    container_name: slimy-web
    restart: unless-stopped
    env_file:
      - /opt/slimy/secrets/.env.web.production
    environment:
      HOST: 0.0.0.0
      PORT: 3000
      # Point Codes Aggregator at Snelp's published codes JSON feed.
      NEXT_PUBLIC_SNELP_CODES_URL: https://www.snelp.com/codes/codes.json
      NEXT_TELEMETRY_DISABLED: "1"
    depends_on:
      slimy-db:
        condition: service_healthy
      admin-api:
        condition: service_started
    ports:
      - "3000:3000"
    volumes:
      - /opt/slimy/logs/web:/app/logs
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://127.0.0.1:3000/', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1));\""]
      interval: 30s
      timeout: 5s
      retries: 6
      start_period: 30s
    networks:
      - slimy

  caddy:
    image: caddy:2
    container_name: slimy-caddy
    restart: unless-stopped
    depends_on:
      web:
        condition: service_healthy
      admin-api:
        condition: service_started
    network_mode: host
    volumes:
      - ./Caddyfile.slimy-nuc2:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

  loopback1455:
    image: python:3-alpine
    container_name: slimy-loopback1455
    restart: unless-stopped
    command: ["python3", "-m", "http.server", "1455"]
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:1455 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
    ports:
      - "1455:1455"
    networks:
      - slimy

networks:
  slimy:
    name: slimy-network

volumes:
  slimy-db-data:
    external: true
    name: slimy-db-data
  caddy_data:
    external: true
    name: slimyai-web_caddy_data
  caddy_config:
    external: true
    name: slimyai-web_caddy_config
