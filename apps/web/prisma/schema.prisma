// Prisma Schema for SlimyAI Web
// This defines the database schema for the application

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Club Analysis
model ClubAnalysis {
  id          String   @id @default(cuid())
  guildId     String   @map("guild_id")
  userId      String   @map("user_id")
  title       String?
  summary     String
  confidence  Float
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  images      ClubAnalysisImage[]
  metrics     ClubMetric[]

  @@index([guildId])
  @@index([userId])
  @@index([createdAt])
  @@map("club_analyses")
}

// Club Analysis Images
model ClubAnalysisImage {
  id           String   @id @default(cuid())
  analysisId   String   @map("analysis_id")
  imageUrl     String   @map("image_url")
  originalName String   @map("original_name")
  fileSize     Int      @map("file_size")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  // Relations
  analysis     ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@map("club_analysis_images")
}

// Club Metrics
model ClubMetric {
  id         String   @id @default(cuid())
  analysisId String   @map("analysis_id")
  name       String
  value      String   // Stored as JSON string for flexibility
  unit       String?
  category   String
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  analysis   ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@index([category])
  @@map("club_metrics")
}

// Club Sheet (spreadsheet data)
model ClubSheet {
  id        String   @id @default(cuid())
  guildId   String   @unique @map("guild_id")
  data      Json     // Stores the spreadsheet cells
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([guildId])
  @@map("club_sheets")
}

// User Preferences
model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  theme             String   @default("auto") // light, dark, auto
  language          String   @default("en")
  notifications     Boolean  @default(true)
  chatPersonality   String   @default("helpful")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("user_preferences")
}

// Chat Conversations
model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  mode      String   @default("helpful")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages  ChatMessage[]

  @@index([userId])
  @@index([createdAt])
  @@map("chat_conversations")
}

// Chat Messages
model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // user, assistant, system
  content        String   @db.Text
  timestamp      DateTime @default(now())

  // Relations
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
  @@map("chat_messages")
}

// Guild Feature Flags (for persistence)
model GuildFeatureFlags {
  id              String   @id @default(cuid())
  guildId         String   @unique
  colorPrimary    String?
  badgeStyle      String?  // rounded, square, pill
  ensembleOCR     Boolean  @default(false)
  secondApprover  Boolean  @default(false)
  askManus        Boolean  @default(false)
  publicStats     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([guildId])
  @@map("guild_feature_flags")
}

// Code Reports (for tracking reported codes)
model CodeReport {
  id        String   @id @default(cuid())
  code      String
  reason    String   // expired, invalid, duplicate, other
  details   String?  @db.Text
  reportedBy String
  status    String   @default("pending") // pending, verified, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([createdAt])
  @@map("code_reports")
}

// Audit Logs (for persistence)
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  username   String?
  action     String
  resource   String
  resourceId String?
  changes    String?  @db.Text // JSON string
  ipAddress  String?
  userAgent  String?  @db.Text
  status     String   // success, failure
  errorMsg   String?  @db.Text
  metadata   String?  @db.Text // JSON string
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// User Sessions (optional - for session management)
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}

// ============================================
// TRADER AUTHENTICATION (Isolated System)
// Separate from Discord-based main auth
// ============================================

// Trader User - username/password auth
model TraderUser {
  id           String          @id @default(cuid())
  username     String          @unique
  passwordHash String          @map("password_hash") @db.VarChar(255)
  disabled     Boolean         @default(false)
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  sessions     TraderSession[]
  inviteUsed   TraderInvite?   @relation("InviteUsedBy")

  @@index([username])
  @@map("trader_users")
}

// Trader Invite Codes - invite-only registration
model TraderInvite {
  id        String    @id @default(cuid())
  codeHash  String    @unique @map("code_hash") @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")
  maxUses   Int       @default(1) @map("max_uses")
  useCount  Int       @default(0) @map("use_count")
  usedAt    DateTime? @map("used_at")
  usedById  String?   @unique @map("used_by_id")
  note      String?   @db.VarChar(255)

  usedBy    TraderUser? @relation("InviteUsedBy", fields: [usedById], references: [id])

  @@index([codeHash])
  @@map("trader_invites")
}

// Trader Sessions - isolated from main app sessions
model TraderSession {
  id         String    @id @default(cuid())
  tokenHash  String    @unique @map("token_hash") @db.VarChar(255)
  userId     String    @map("user_id")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  lastSeenAt DateTime  @default(now()) @map("last_seen_at")
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  createdAt  DateTime  @default(now()) @map("created_at")

  user       TraderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("trader_sessions")
}

// Trader Login Attempts - for rate limiting
model TraderLoginAttempt {
  id          String   @id @default(cuid())
  username    String
  ipAddress   String   @map("ip_address") @db.VarChar(45)
  success     Boolean  @default(false)
  attemptedAt DateTime @default(now()) @map("attempted_at")

  @@index([username, attemptedAt])
  @@index([ipAddress, attemptedAt])
  @@map("trader_login_attempts")
}
