// Prisma Schema for SlimyAI Web
// This defines the database schema for the application
// This is the unified schema for both Discord auth and trader auth systems

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// DISCORD AUTHENTICATION
// Main OAuth-based auth system
// ============================================

// Discord users
model User {
  id          String   @id @default(cuid())
  discordId   String   @unique @map("discord_id")
  email       String?  @unique
  discordAccessToken  String? @map("discord_access_token")
  discordRefreshToken String? @map("discord_refresh_token")
  tokenExpiresAt      DateTime? @map("token_expires_at")
  username    String?
  globalName  String?  @map("global_name")
  avatar      String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  sessions      Session[]
  ownedGuilds   Guild[] @relation("GuildOwner")
  userGuilds    UserGuild[]
  conversations Conversation[]
  stats         Stat[]
  chatMessages  ChatMessage[]
  clubAnalyses  ClubAnalysis[]
  screenshotAnalyses ScreenshotAnalysis[]
  screenshotComparisons ScreenshotComparison[]
  auditLogs     AuditLog[]
  userSettings  UserSettings?
  lastActiveGuildId String? @map("last_active_guild_id")
  lastActiveGuild   Guild?  @relation("LastActiveGuild", fields: [lastActiveGuildId], references: [id], onDelete: SetNull)

  // Performance indexes
  @@index([createdAt])
  @@index([updatedAt])
  @@index([discordId, createdAt])
  @@index([lastActiveGuildId])

  @@map("users")
}

// User authentication sessions
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@index([userId, expiresAt])

  @@map("sessions")
}

// Discord guilds (servers)
model Guild {
  id        String   @id // Discord Guild ID
  name      String
  icon      String?
  ownerId   String   @map("owner_id")
  settings  Json?    // JSON object for guild-specific settings
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  owner         User          @relation("GuildOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  userGuilds    UserGuild[]
  stats         Stat[]
  chatMessages  ChatMessage[]
  clubAnalyses  ClubAnalysis[]
  guildSettingsCentral GuildSettingsCentral?
  activeUsers   User[]        @relation("LastActiveGuild")

  // Performance indexes
  @@index([ownerId])
  @@index([createdAt])
  @@index([updatedAt])

  @@map("guilds")
}

// Many-to-many relationship between users and guilds with roles
model UserGuild {
  id     String @id @default(cuid())
  userId String @map("user_id")
  guildId String @map("guild_id")
  roles  Json?  // JSON array of role strings

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([guildId])
  @@index([userId, guildId])

  @@unique([userId, guildId])
  @@map("user_guilds")
}

// Chat conversations
model Conversation {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("conversations")
}

// Individual chat messages
model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String?  @map("conversation_id")
  userId         String   @map("user_id")
  guildId        String?  @map("guild_id")
  text           String
  adminOnly      Boolean  @default(false) @map("admin_only")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild        Guild?        @relation(fields: [guildId], references: [id], onDelete: SetNull)

  // Performance indexes
  @@index([userId])
  @@index([guildId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([guildId, createdAt])
  @@index([conversationId, createdAt])
  @@index([adminOnly, createdAt])

  @@map("chat_messages")
}

// Statistics and analytics
model Stat {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  guildId   String?  @map("guild_id")
  type      String   // Type of statistic (e.g., 'message_count', 'command_usage', etc.)
  value     Json     // JSON value - can be number, string, object, etc.
  timestamp DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild Guild? @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([guildId])
  @@index([type])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([guildId, timestamp])
  @@index([type, timestamp])
  @@index([userId, type, timestamp])
  @@index([guildId, type, timestamp])

  @@map("stats")
}

// Club analytics results
model ClubAnalysis {
  id          String   @id @default(cuid())
  guildId     String   @map("guild_id")
  userId      String   @map("user_id") // User who initiated the analysis
  title       String?  // Optional title for the analysis
  summary     String   // AI-generated summary
  confidence  Float    // Confidence score (0-1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  guild       Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  images      ClubAnalysisImage[]
  metrics     ClubMetric[]

  // Performance indexes
  @@index([guildId])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([confidence])
  @@index([guildId, createdAt])
  @@index([userId, createdAt])
  @@index([guildId, confidence])
  @@index([userId, confidence])

  @@map("club_analyses")
}

// Images associated with club analyses
model ClubAnalysisImage {
  id            String   @id @default(cuid())
  analysisId    String   @map("analysis_id")
  imageUrl      String   @map("image_url") // URL to the uploaded image
  originalName  String   @map("original_name") // Original filename
  fileSize      Int      @map("file_size") // File size in bytes
  uploadedAt    DateTime @default(now()) @map("uploaded_at")

  // Relations
  analysis ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([uploadedAt])
  @@index([fileSize])

  @@map("club_analysis_images")
}

// Individual metrics extracted from analyses
model ClubMetric {
  id          String  @id @default(cuid())
  analysisId  String  @map("analysis_id")
  name        String  // Metric name (e.g., 'totalMembers', 'performanceScore')
  value       Json    // Metric value (can be number, string, object)
  unit        String? // Optional unit (e.g., 'count', 'percentage', 'score')
  category    String  // Category (e.g., 'membership', 'performance', 'activity')

  // Relations
  analysis ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([name])
  @@index([category])
  @@index([analysisId, name])
  @@index([analysisId, category])
  @@index([category, name])

  @@unique([analysisId, name])
  @@map("club_metrics")
}

// Club Sheet Data (spreadsheet storage)
model ClubSheet {
  id        String   @id @default(cuid())
  guildId   String   @unique @map("guild_id")
  data      Json
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([guildId])
  @@map("club_sheets")
}

// Screenshot analysis results
model ScreenshotAnalysis {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  screenshotType  String   @map("screenshot_type") // Type of screenshot (game-stats, leaderboard, etc.)
  imageUrl        String   @map("image_url") // URL to the screenshot
  title           String   // Analysis title
  description     String   // Brief description
  summary         String   // AI-generated summary
  confidence      Float    // Confidence score (0-1)
  processingTime  Int      @map("processing_time") // Processing time in milliseconds
  modelUsed       String   @map("model_used") // AI model used for analysis
  rawResponse     Json?    @map("raw_response") // Raw AI response data
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  data            ScreenshotData[]
  tags            ScreenshotTag[]
  insights        ScreenshotInsight[]
  recommendations  ScreenshotRecommendation[]
  comparisons1    ScreenshotComparison[] @relation("ScreenshotComparisonAnalysis1")
  comparisons2    ScreenshotComparison[] @relation("ScreenshotComparisonAnalysis2")

  // Performance indexes
  @@index([userId])
  @@index([screenshotType])
  @@index([createdAt])
  @@index([confidence])
  @@index([userId, screenshotType])
  @@index([userId, createdAt])
  @@index([screenshotType, createdAt])

  @@map("screenshot_analyses")
}

// Extracted data from screenshot analysis
model ScreenshotData {
  id          String   @id @default(cuid())
  analysisId  String   @map("analysis_id")
  key         String   // Data key (e.g., 'level', 'score', 'rank')
  value       Json     // Data value (can be string, number, object, array)
  dataType    String   @map("data_type") // Type of data (string, number, object, array)
  category    String   // Category (stats, metadata, ui-elements, etc.)
  confidence  Float?   // Confidence score for this specific data point

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([key])
  @@index([category])
  @@index([analysisId, key])
  @@index([analysisId, category])
  @@index([category, key])

  @@unique([analysisId, key])
  @@map("screenshot_data")
}

// Tags associated with screenshot analyses
model ScreenshotTag {
  id         String   @id @default(cuid())
  analysisId String   @map("analysis_id")
  tag        String   // Tag name
  category   String?  // Tag category (content, feature, quality, etc.)

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([tag])
  @@index([category])
  @@index([analysisId, tag])
  @@index([category, tag])

  @@unique([analysisId, tag])
  @@map("screenshot_tags")
}

// Screenshot comparison results
model ScreenshotComparison {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  analysisId1   String   @map("analysis_id_1")
  analysisId2   String   @map("analysis_id_2")
  comparisonType String  @map("comparison_type") // Type of comparison (difference, trend, similarity)
  summary       String   // Comparison summary
  trend         String   // Overall trend (improving, declining, stable, unknown)
  differences   Json     // Detailed differences between analyses
  insights      Json     // Key insights from comparison
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis1     ScreenshotAnalysis @relation("ScreenshotComparisonAnalysis1", fields: [analysisId1], references: [id], onDelete: Cascade)
  analysis2     ScreenshotAnalysis @relation("ScreenshotComparisonAnalysis2", fields: [analysisId2], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([analysisId1])
  @@index([analysisId2])
  @@index([comparisonType])
  @@index([createdAt])
  @@index([userId, createdAt])

  @@unique([analysisId1, analysisId2, comparisonType])
  @@map("screenshot_comparisons")
}

// Insights extracted from screenshot analyses
model ScreenshotInsight {
  id          String   @id @default(cuid())
  analysisId  String   @map("analysis_id")
  type        String   // Type of insight (performance, ui, content, etc.)
  priority    String   // Priority level (high, medium, low)
  title       String   // Insight title
  description String   // Detailed description
  confidence  Float    // Confidence score for this insight
  actionable  Boolean  @default(false) // Whether this insight suggests action
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([type])
  @@index([priority])
  @@index([actionable])
  @@index([analysisId, type])
  @@index([analysisId, priority])

  @@map("screenshot_insights")
}

// Recommendations based on screenshot analysis
model ScreenshotRecommendation {
  id          String   @id @default(cuid())
  analysisId  String   @map("analysis_id")
  type        String   // Type of recommendation (improvement, optimization, feature, etc.)
  priority    String   // Priority level (high, medium, low)
  title       String   // Recommendation title
  description String   // Detailed description
  impact      String   // Expected impact (high, medium, low)
  effort      String   // Implementation effort (high, medium, low)
  actionable  Boolean  @default(true) // Whether this is actionable
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([type])
  @@index([priority])
  @@index([impact])
  @@index([effort])
  @@index([analysisId, priority])
  @@index([analysisId, type])

  @@map("screenshot_recommendations")
}

// Audit logs for event sourcing and compliance
model AuditLog {
  id            String   @id @default(cuid())
  userId        String?  @map("user_id") // User who performed the action (null for system actions)
  action        String   // Action performed (e.g., 'login', 'chat_message', 'create_conversation')
  resourceType  String   @map("resource_type") // Type of resource (e.g., 'user', 'chat', 'guild')
  resourceId    String   @map("resource_id") // ID of the affected resource
  details       Json?    // Additional details about the action
  ipAddress     String?  @map("ip_address") // IP address of the user
  userAgent     String?  @map("user_agent") // User agent string
  sessionId     String?  @map("session_id") // Session ID for tracking
  requestId     String?  @map("request_id") // Request ID for correlation
  timestamp     DateTime @default(now())
  success       Boolean  @default(true) // Whether the action was successful
  errorMessage  String?  @map("error_message") // Error message if action failed

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Performance indexes
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([resourceId])
  @@index([timestamp])
  @@index([success])
  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([resourceType, timestamp])
  @@index([userId, action, timestamp])
  @@index([resourceType, resourceId])
  @@index([requestId])

  @@map("audit_logs")
}

// Legacy user settings table used by older web endpoints (/api/me/settings)
model UserSettings {
  userId     String   @id @map("user_id")
  data       Json
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [discordId], onDelete: Cascade)

  @@map("user_settings")
}

// Legacy guild settings table used by older web endpoints
model GuildSettingsCentral {
  guildId    String   @id @map("guild_id")
  data       Json
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@map("guild_settings_central")
}

// ============================================
// TRADER AUTHENTICATION (Isolated System)
// Separate from Discord-based main auth
// ============================================

// Trader User - username/password auth
model TraderUser {
  id           String          @id @default(cuid())
  username     String          @unique
  passwordHash String          @map("password_hash") @db.VarChar(255)
  disabled     Boolean         @default(false)
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")

  sessions     TraderSession[]
  inviteUsed   TraderInvite?   @relation("InviteUsedBy")
  // Chat integration relations
  guildMemberships ChatGuildMembership[]
  messages     ChatRoomMessage[]
  reactions    ChatRoomMessageReaction[]
  dmsSent      ChatDirectMessage[] @relation("DMFromUser")
  dmsReceived  ChatDirectMessage[] @relation("DMToUser")
  presence     ChatPresence?
  notifications ChatNotificationSettings[]

  @@index([username])
  @@map("trader_users")
}

// Trader Invite Codes - invite-only registration
model TraderInvite {
  id        String    @id @default(cuid())
  codeHash  String    @unique @map("code_hash") @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")
  maxUses   Int       @default(1) @map("max_uses")
  useCount  Int       @default(0) @map("use_count")
  usedAt    DateTime? @map("used_at")
  usedById  String?   @unique @map("used_by_id")
  note      String?   @db.VarChar(255)

  usedBy    TraderUser? @relation("InviteUsedBy", fields: [usedById], references: [id])

  @@index([codeHash])
  @@map("trader_invites")
}

// Trader Sessions - isolated from main app sessions
model TraderSession {
  id         String    @id @default(cuid())
  tokenHash  String    @unique @map("token_hash") @db.VarChar(255)
  userId     String    @map("user_id")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  lastSeenAt DateTime  @default(now()) @map("last_seen_at")
  ipAddress  String?   @map("ip_address") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.Text
  createdAt  DateTime  @default(now()) @map("created_at")

  user       TraderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("trader_sessions")
}

// Trader Login Attempts - for rate limiting
model TraderLoginAttempt {
  id          String   @id @default(cuid())
  username    String
  ipAddress   String   @map("ip_address") @db.VarChar(45)
  success     Boolean  @default(false)
  attemptedAt DateTime @default(now()) @map("attempted_at")

  @@index([username, attemptedAt])
  @@index([ipAddress, attemptedAt])
  @@map("trader_login_attempts")
}

// ============================================
// OWNER CONTROL PLANE
// Admin users with elevated privileges
// ============================================

// Owner Allowlist - determines who can access owner APIs
model OwnerAllowlist {
  id          String   @id @default(cuid())
  email       String   @unique // Email from Discord user
  userId      String?  @unique @map("user_id") // Discord user ID if known
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String   @map("created_by") // Email of owner who added this entry
  note        String?  @db.VarChar(255) // Optional note about why they're an owner
  revokedAt   DateTime? @map("revoked_at") // When/if this owner was revoked

  // Inverse relations
  invitesCreated OwnerInvite[] @relation("CreatedBy")
  settingsUpdates AppSettings[] @relation("UpdatedBy")
  auditLogsActor OwnerAuditLog[] @relation("Actor")

  @@index([email])
  @@index([userId])
  @@index([createdAt])
  @@map("owner_allowlist")
}

// Owner Invites - invitation codes for new owners
model OwnerInvite {
  id           String    @id @default(cuid())
  codeHash     String    @unique @map("code_hash") @db.VarChar(255) // SHA256 hex (64 chars)
  createdAt    DateTime  @default(now()) @map("created_at")
  createdById  String    @map("created_by_id")
  expiresAt    DateTime? @map("expires_at")
  maxUses      Int       @default(1) @map("max_uses")
  useCount     Int       @default(0) @map("use_count")
  usedAt       DateTime? @map("used_at")
  revokedAt    DateTime? @map("revoked_at")
  note         String?   @db.VarChar(255) // Internal note about invitation

  // Relations
  createdBy    OwnerAllowlist @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([codeHash])
  @@index([createdById])
  @@index([createdAt])
  @@map("owner_invites")
}

// App Settings - singleton settings for application behavior
model AppSettings {
  id                    String   @id @default(cuid())
  // Refresh rate capping (milliseconds, bounds: 100-3600000)
  refreshRateCapMs      Int      @default(5000) @map("refresh_rate_cap_ms")
  // Feature flags
  debugDockEnabled      Boolean  @default(false) @map("debug_dock_enabled")
  // Display settings
  artifactSourceDisplay String   @default("icon") @map("artifact_source_display") // icon, text, both
  // Audit trail
  updatedAt             DateTime @updatedAt @map("updated_at")
  updatedById           String?  @map("updated_by_id")

  // Relations
  updatedBy             OwnerAllowlist? @relation("UpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@map("app_settings")
}

// Owner Audit Logs - track all owner actions
model OwnerAuditLog {
  id          String   @id @default(cuid())
  actorId     String   @map("actor_id")
  action      String   // INVITE_CREATE, INVITE_REVOKE, SETTINGS_UPDATE
  resourceType String  @map("resource_type") // invite, settings, etc.
  resourceId  String?  @map("resource_id")
  changes     String?  @db.Text // JSON: which fields changed and their values
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  userAgent   String?  @map("user_agent") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  actor       OwnerAllowlist @relation("Actor", fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@map("owner_audit_logs")
}

// ============================================
// CHAT APP INTEGRATION (Chat Rooms)
// Adapted from standalone chat-app
// Uses TraderUser/TraderSession for auth
// ============================================

// Chat Guilds - renamed from chat-app Guild to avoid conflict
model ChatGuild {
  id        String   @id @default(cuid())
  name      String
  iconUrl   String?  @map("icon_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  channels   ChatChannel[]
  memberships ChatGuildMembership[]
  invites    ChatInvite[]

  @@map("chat_guilds")
}

// Chat Channels - renamed from chat-app Channel
model ChatChannel {
  id        String   @id @default(cuid())
  name      String
  topic     String?
  guildId   String   @map("guild_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  guild   ChatGuild         @relation(fields: [guildId], references: [id], onDelete: Cascade)
  messages ChatRoomMessage[]
  pinned   ChatPinnedMessage[]

  @@index([guildId])
  @@map("chat_channels")
}

// Guild Memberships - tracks which TraderUsers belong to which ChatGuilds
model ChatGuildMembership {
  id      String   @id @default(cuid())
  userId  String   @map("user_id")
  guildId String   @map("guild_id")
  roles   Json     @default("[\"member\"]") // ["admin", "moderator", "member"]
  joinedAt DateTime @default(now()) @map("joined_at")

  user  TraderUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild ChatGuild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([userId, guildId])
  @@index([guildId])
  @@map("chat_guild_memberships")
}

// Chat Room Messages - renamed from chat-app ChatMessage
model ChatRoomMessage {
  id        String    @id @default(cuid())
  text      String    @db.VarChar(4000)
  userId    String    @map("user_id")
  channelId String    @map("channel_id")
  editedAt  DateTime? @map("edited_at")
  deletedAt DateTime? @map("deleted_at") // soft delete
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  user     TraderUser              @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel  ChatChannel           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reactions ChatRoomMessageReaction[]
  files    ChatFileMetadata[]
  pinnedIn ChatPinnedMessage?

  @@index([channelId, createdAt])
  @@index([userId])
  @@map("chat_room_messages")
}

// Direct Messages
model ChatDirectMessage {
  id         String    @id @default(cuid())
  text       String    @db.VarChar(4000)
  fromUserId String    @map("from_user_id")
  toUserId   String    @map("to_user_id")
  editedAt   DateTime? @map("edited_at")
  deletedAt  DateTime? @map("deleted_at") // soft delete
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  fromUser TraderUser @relation("DMFromUser", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser   TraderUser @relation("DMToUser", fields: [toUserId], references: [id], onDelete: Cascade)
  files    ChatFileMetadata[]

  @@index([fromUserId, toUserId, createdAt])
  @@index([toUserId, fromUserId, createdAt])
  @@map("chat_direct_messages")
}

// Message Reactions - renamed for ChatRoomMessage
model ChatRoomMessageReaction {
  id        String @id @default(cuid())
  emoji     String // unicode emoji or custom shortcode
  userId    String @map("user_id")
  messageId String @map("message_id")

  user    TraderUser        @relation(fields: [userId], references: [id], onDelete: Cascade)
  message ChatRoomMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId, emoji])
  @@index([messageId])
  @@map("chat_room_message_reactions")
}

// Pinned Messages
model ChatPinnedMessage {
  id        String   @id @default(cuid())
  messageId String   @unique @map("message_id")
  channelId String   @map("channel_id")
  pinnedBy  String   @map("pinned_by")
  pinnedAt  DateTime @default(now()) @map("pinned_at")

  message ChatRoomMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  channel ChatChannel     @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@map("chat_pinned_messages")
}

// File Metadata for uploads
model ChatFileMetadata {
  id           String   @id @default(cuid())
  filename     String
  mimeType     String   @map("mime_type")
  sizeBytes    Int      @map("size_bytes")
  storagePath  String   @map("storage_path")
  messageId    String?  // null if attached to DM
  dmId         String?  // null if attached to channel message
  uploadedAt   DateTime @default(now()) @map("uploaded_at")
  expiresAt    DateTime @map("expires_at") // default 30 days from upload

  message ChatRoomMessage?  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  dm      ChatDirectMessage? @relation(fields: [dmId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([dmId])
  @@index([expiresAt])
  @@map("chat_file_metadata")
}

// Chat Invites
model ChatInvite {
  id        String    @id @default(cuid())
  code      String    @unique
  guildId   String    @map("guild_id")
  createdBy String    @map("created_by")
  expiresAt DateTime? @map("expires_at")
  maxUses   Int?      @map("max_uses")
  uses      Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")

  guild ChatGuild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([code])
  @@map("chat_invites")
}

// Chat Presence - online/offline status
model ChatPresence {
  id       String   @id @default(cuid())
  userId   String   @unique @map("user_id")
  status   String   @default("offline") // online, idle, offline
  lastSeen DateTime @default(now()) @map("last_seen")

  user TraderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_presences")
}

// Chat Notification Settings
model ChatNotificationSettings {
  id        String  @id @default(cuid())
  userId    String  @map("user_id")
  channelId String? @map("channel_id") // null for DM settings
  dmUserId  String? @map("dm_user_id") // null for channel settings
  level     String  @default("all") // all, mentions, none

  user TraderUser @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("chat_notification_settings")
}

// Chat tables added - relations are now on the main TraderUser model above
