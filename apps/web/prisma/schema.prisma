// Prisma Schema for SlimyAI Web
// This defines the database schema for the application

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// DEPRECATED: Club Analysis models moved to admin-api
//
// NOTE: As of Phase 2.1 (Database Consolidation), club analytics are canonically
// stored in admin-api's Prisma schema. These web app models are deprecated.
//
// Migration Plan:
// 1. Existing data should be migrated to admin-api database
// 2. Web app should read/write club analytics via admin-api endpoints (/api/club-analytics/*)
// 3. These models will be removed in a future migration
//
// For new code, use the admin-api endpoints instead of querying these models directly.

// Club Analysis (DEPRECATED - use admin-api instead)
model ClubAnalysis {
  id          String   @id @default(cuid())
  guildId     String
  userId      String
  title       String?
  summary     String
  confidence  Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  images      ClubAnalysisImage[]
  metrics     ClubMetric[]

  @@index([guildId])
  @@index([userId])
  @@index([createdAt])
  @@map("club_analyses")
}

// Club Analysis Images (DEPRECATED - use admin-api instead)
model ClubAnalysisImage {
  id           String   @id @default(cuid())
  analysisId   String
  imageUrl     String
  originalName String
  fileSize     Int
  uploadedAt   DateTime @default(now())

  // Relations
  analysis     ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@map("club_analysis_images")
}

// Club Metrics (DEPRECATED - use admin-api instead)
model ClubMetric {
  id         String   @id @default(cuid())
  analysisId String
  name       String
  value      String   // Stored as JSON string for flexibility
  unit       String?
  category   String
  createdAt  DateTime @default(now())

  // Relations
  analysis   ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@index([category])
  @@map("club_metrics")
}

// User Preferences
model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  theme             String   @default("auto") // light, dark, auto
  language          String   @default("en")
  notifications     Boolean  @default(true)
  chatPersonality   String   @default("helpful")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("user_preferences")
}

// AI Chat Conversations (OpenAI-style AI conversations)
// NOTE: This is for user interactions with AI, NOT guild communications.
// For guild chat, see admin-api's GuildConversation model.
model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  mode      String   @default("helpful")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages  ChatMessage[]

  @@index([userId])
  @@index([createdAt])
  @@map("chat_conversations")
}

// AI Chat Messages (OpenAI-style AI conversations)
// NOTE: This is for user-to-AI messages, NOT guild communications.
// For guild messages, see admin-api's GuildChatMessage model.
// This model represents individual messages with role (user/assistant/system).
model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // user, assistant, system
  content        String   @db.Text
  timestamp      DateTime @default(now())

  // Relations
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
  @@map("chat_messages")
}

// Guild Feature Flags (for persistence)
model GuildFeatureFlags {
  id              String   @id @default(cuid())
  guildId         String   @unique
  colorPrimary    String?
  badgeStyle      String?  // rounded, square, pill
  ensembleOCR     Boolean  @default(false)
  secondApprover  Boolean  @default(false)
  askManus        Boolean  @default(false)
  publicStats     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([guildId])
  @@map("guild_feature_flags")
}

// Code Reports (for tracking reported codes)
model CodeReport {
  id        String   @id @default(cuid())
  code      String
  reason    String   // expired, invalid, duplicate, other
  details   String?  @db.Text
  reportedBy String
  status    String   @default("pending") // pending, verified, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([createdAt])
  @@map("code_reports")
}

// DEPRECATED: Audit Logs (for persistence)
//
// NOTE: As of Phase 2.1 (Database Consolidation), audit logs are canonically
// stored in admin-api's Prisma schema. This web app model is deprecated.
//
// The admin-api version includes additional fields (requestId, sessionId, tracing info)
// and is the single source of truth for all system audits.
//
// Migration Plan:
// 1. Existing web audit logs should be migrated to admin-api
// 2. Web app should submit audit events via admin-api endpoints (/api/audit-log/*)
// 3. This model will be removed in a future migration
//
// For new code, use admin-api audit log submission endpoints instead of querying this model.

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  username   String?
  action     String
  resource   String
  resourceId String?
  changes    String?  @db.Text // JSON string
  ipAddress  String?
  userAgent  String?  @db.Text
  status     String   // success, failure
  errorMsg   String?  @db.Text
  metadata   String?  @db.Text // JSON string
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// User Sessions (optional - for session management)
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}
