// Prisma Schema for SlimyAI Web
// This defines the database schema for the application

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client-web"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Preferences
model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  theme             String   @default("auto") // light, dark, auto
  language          String   @default("en")
  notifications     Boolean  @default(true)
  chatPersonality   String   @default("helpful")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("user_preferences")
}

// AI Chat Conversations (OpenAI-style AI conversations)
// NOTE: This is for user interactions with AI, NOT guild communications.
// For guild chat, see admin-api's GuildConversation model.
model ChatConversation {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  mode      String   @default("helpful")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages  ChatMessage[]

  @@index([userId])
  @@index([createdAt])
  @@map("chat_conversations")
}

// AI Chat Messages (OpenAI-style AI conversations)
// NOTE: This is for user-to-AI messages, NOT guild communications.
// For guild messages, see admin-api's GuildChatMessage model.
// This model represents individual messages with role (user/assistant/system).
model ChatMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // user, assistant, system
  content        String   @db.Text
  timestamp      DateTime @default(now())

  // Relations
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
  @@map("chat_messages")
}

// Guild Feature Flags (for persistence)
model GuildFeatureFlags {
  id              String   @id @default(cuid())
  guildId         String   @unique
  colorPrimary    String?
  badgeStyle      String?  // rounded, square, pill
  ensembleOCR     Boolean  @default(false)
  secondApprover  Boolean  @default(false)
  askManus        Boolean  @default(false)
  publicStats     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([guildId])
  @@map("guild_feature_flags")
}

// Code Reports (for tracking reported codes)
model CodeReport {
  id        String   @id @default(cuid())
  code      String
  reason    String   // expired, invalid, duplicate, other
  details   String?  @db.Text
  reportedBy String
  status    String   @default("pending") // pending, verified, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@index([createdAt])
  @@map("code_reports")
}

// User Sessions (optional - for session management)
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("user_sessions")
}
