// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Discord users
model User {
  id          String   @id @default(cuid())
  discordId   String   @unique @map("discord_id")
  username    String?
  globalName  String?  @map("global_name")
  avatar      String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  sessions         Session[]
  userGuilds       UserGuild[]
  guildConversations GuildConversation[] @relation("guild_conversations")
  guildChatMessages GuildChatMessage[] @relation("guild_chat_messages")
  stats            Stat[]
  clubAnalyses     ClubAnalysis[]
  screenshotAnalyses ScreenshotAnalysis[]
  screenshotComparisons ScreenshotComparison[]
  auditLogs        AuditLog[]

  // Performance indexes
  @@index([createdAt])
  @@index([updatedAt])
  @@index([discordId, createdAt])

  @@map("users")
}

// User authentication sessions
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([expiresAt])
  @@index([token])
  @@index([userId, expiresAt])

  @@map("sessions")
}

// Discord guilds (servers)
model Guild {
  id        String   @id @default(cuid())
  discordId String   @unique @map("discord_id")
  name      String
  settings  Json?    // JSON object for guild-specific settings
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  userGuilds       UserGuild[]
  stats            Stat[]
  guildChatMessages GuildChatMessage[]
  clubAnalyses     ClubAnalysis[]
  guildSettings    GuildSettings?
  guildPersonality GuildPersonality?

  // Performance indexes
  @@index([createdAt])
  @@index([updatedAt])
  @@index([discordId, createdAt])

  @@map("guilds")
}

// Many-to-many relationship between users and guilds with roles
model UserGuild {
  id     String @id @default(cuid())
  userId String @map("user_id")
  guildId String @map("guild_id")
  roles  Json?  // JSON array of role strings

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([guildId])
  @@index([userId, guildId])

  @@unique([userId, guildId])
  @@map("user_guilds")
}

// Guild Chat Conversations (Discord-style guild communication)
// NOTE: This is for guild member communications, NOT AI conversations.
// For AI chat, see web app's AiChatConversation model.
model GuildConversation {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  title     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation("guild_conversations", fields: [userId], references: [id], onDelete: Cascade)
  messages GuildChatMessage[]

  @@map("conversations")
}

// Guild Chat Messages (Discord-style guild communication)
// NOTE: This is for guild member communications, NOT AI chat messages.
// For AI messages, see web app's ChatMessage model (stored in web database).
// This model represents text messages within guild conversations.
model GuildChatMessage {
  id             String   @id @default(cuid())
  conversationId String?  @map("conversation_id")
  userId         String   @map("user_id")
  guildId        String?  @map("guild_id")
  text           String
  adminOnly      Boolean  @default(false) @map("admin_only")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  conversation GuildConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  user         User               @relation("guild_chat_messages", fields: [userId], references: [id], onDelete: Cascade)
  guild        Guild?             @relation(fields: [guildId], references: [id], onDelete: SetNull)

  // Performance indexes
  @@index([userId])
  @@index([guildId])
  @@index([conversationId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([guildId, createdAt])
  @@index([conversationId, createdAt])
  @@index([adminOnly, createdAt])

  @@map("chat_messages")
}

// Statistics and analytics
model Stat {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  guildId   String?  @map("guild_id")
  type      String   // Type of statistic (e.g., 'message_count', 'command_usage', etc.)
  value     Json     // JSON value - can be number, string, object, etc.
  timestamp DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  guild Guild? @relation(fields: [guildId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([guildId])
  @@index([type])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([guildId, timestamp])
  @@index([type, timestamp])
  @@index([userId, type, timestamp])
  @@index([guildId, type, timestamp])

  @@map("stats")
}

// Club analytics results
model ClubAnalysis {
  id          String   @id @default(cuid())
  guildId     String   @map("guild_id")
  userId      String   @map("user_id") // User who initiated the analysis
  title       String?  // Optional title for the analysis
  summary     String   // AI-generated summary
  confidence  Float    // Confidence score (0-1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  guild       Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  images      ClubAnalysisImage[]
  metrics     ClubMetric[]

  // Performance indexes
  @@index([guildId])
  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([confidence])
  @@index([guildId, createdAt])
  @@index([userId, createdAt])
  @@index([guildId, confidence])
  @@index([userId, confidence])

  @@map("club_analyses")
}

// Images associated with club analyses
model ClubAnalysisImage {
  id            String   @id @default(cuid())
  analysisId    String   @map("analysis_id")
  imageUrl      String   @map("image_url") // URL to the uploaded image
  originalName  String   @map("original_name") // Original filename
  fileSize      Int      @map("file_size") // File size in bytes
  uploadedAt    DateTime @default(now()) @map("uploaded_at")

  // Relations
  analysis ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([uploadedAt])
  @@index([fileSize])

  @@map("club_analysis_images")
}

// Individual metrics extracted from analyses
model ClubMetric {
  id          String  @id @default(cuid())
  analysisId  String  @map("analysis_id")
  name        String  // Metric name (e.g., 'totalMembers', 'performanceScore')
  value       Json    // Metric value (can be number, string, object)
  unit        String? // Optional unit (e.g., 'count', 'percentage', 'score')
  category    String  // Category (e.g., 'membership', 'performance', 'activity')

  // Relations
  analysis ClubAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([name])
  @@index([category])
  @@index([analysisId, name])
  @@index([analysisId, category])
  @@index([category, name])

  @@unique([analysisId, name])
  @@map("club_metrics")
}

// Screenshot analysis results
model ScreenshotAnalysis {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  screenshotType  String   @map("screenshot_type") // Type of screenshot (game-stats, leaderboard, etc.)
  imageUrl        String   @map("image_url") // URL to the screenshot
  title           String   // Analysis title
  description     String   // Brief description
  summary         String   // AI-generated summary
  confidence      Float    // Confidence score (0-1)
  processingTime  Int      @map("processing_time") // Processing time in milliseconds
  modelUsed       String   @map("model_used") // AI model used for analysis
  rawResponse     Json?    @map("raw_response") // Raw AI response data
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  data            ScreenshotData[]
  tags            ScreenshotTag[]
  insights        ScreenshotInsight[]
  recommendations  ScreenshotRecommendation[]
  comparisons1    ScreenshotComparison[] @relation("ScreenshotComparisonAnalysis1")
  comparisons2    ScreenshotComparison[] @relation("ScreenshotComparisonAnalysis2")

  // Performance indexes
  @@index([userId])
  @@index([screenshotType])
  @@index([createdAt])
  @@index([confidence])
  @@index([userId, screenshotType])
  @@index([userId, createdAt])
  @@index([screenshotType, createdAt])

  @@map("screenshot_analyses")
}

// Extracted data from screenshot analysis
model ScreenshotData {
  id          String   @id @default(cuid())
  analysisId  String   @map("analysis_id")
  key         String   // Data key (e.g., 'level', 'score', 'rank')
  value       Json     // Data value (can be string, number, object, array)
  dataType    String   @map("data_type") // Type of data (string, number, object, array)
  category    String   // Category (stats, metadata, ui-elements, etc.)
  confidence  Float?   // Confidence score for this specific data point

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([key])
  @@index([category])
  @@index([analysisId, key])
  @@index([analysisId, category])
  @@index([category, key])

  @@unique([analysisId, key])
  @@map("screenshot_data")
}

// Tags associated with screenshot analyses
model ScreenshotTag {
  id         String   @id @default(cuid())
  analysisId String   @map("analysis_id")
  tag        String   // Tag name
  category   String?  // Tag category (content, feature, quality, etc.)

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([tag])
  @@index([category])
  @@index([analysisId, tag])
  @@index([category, tag])

  @@unique([analysisId, tag])
  @@map("screenshot_tags")
}

// Screenshot comparison results
model ScreenshotComparison {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  analysisId1   String   @map("analysis_id_1")
  analysisId2   String   @map("analysis_id_2")
  comparisonType String  @map("comparison_type") // Type of comparison (difference, trend, similarity)
  summary       String   // Comparison summary
  trend         String   // Overall trend (improving, declining, stable, unknown)
  differences   Json     // Detailed differences between analyses
  insights      Json     // Key insights from comparison
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis1     ScreenshotAnalysis @relation("ScreenshotComparisonAnalysis1", fields: [analysisId1], references: [id], onDelete: Cascade)
  analysis2     ScreenshotAnalysis @relation("ScreenshotComparisonAnalysis2", fields: [analysisId2], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId])
  @@index([analysisId1])
  @@index([analysisId2])
  @@index([comparisonType])
  @@index([createdAt])
  @@index([userId, createdAt])

  @@unique([analysisId1, analysisId2, comparisonType])
  @@map("screenshot_comparisons")
}

// Insights extracted from screenshot analyses
model ScreenshotInsight {
  id          String   @id @default(cuid())
  analysisId  String   @map("analysis_id")
  type        String   // Type of insight (performance, ui, content, etc.)
  priority    String   // Priority level (high, medium, low)
  title       String   // Insight title
  description String   // Detailed description
  confidence  Float    // Confidence score for this insight
  actionable  Boolean  @default(false) // Whether this insight suggests action
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([type])
  @@index([priority])
  @@index([actionable])
  @@index([analysisId, type])
  @@index([analysisId, priority])

  @@map("screenshot_insights")
}

// Recommendations based on screenshot analysis
model ScreenshotRecommendation {
  id          String   @id @default(cuid())
  analysisId  String   @map("analysis_id")
  type        String   // Type of recommendation (improvement, optimization, feature, etc.)
  priority    String   // Priority level (high, medium, low)
  title       String   // Recommendation title
  description String   // Detailed description
  impact      String   // Expected impact (high, medium, low)
  effort      String   // Implementation effort (high, medium, low)
  actionable  Boolean  @default(true) // Whether this is actionable
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  analysis ScreenshotAnalysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([analysisId])
  @@index([type])
  @@index([priority])
  @@index([impact])
  @@index([effort])
  @@index([analysisId, priority])
  @@index([analysisId, type])

  @@map("screenshot_recommendations")
}

// Audit logs for event sourcing and compliance
model AuditLog {
  id            String   @id @default(cuid())
  userId        String?  @map("user_id") // User who performed the action (null for system actions)
  action        String   // Action performed (e.g., 'login', 'chat_message', 'create_conversation')
  resourceType  String   @map("resource_type") // Type of resource (e.g., 'user', 'chat', 'guild')
  resourceId    String   @map("resource_id") // ID of the affected resource
  details       Json?    // Additional details about the action
  ipAddress     String?  @map("ip_address") // IP address of the user
  userAgent     String?  @map("user_agent") // User agent string
  sessionId     String?  @map("session_id") // Session ID for tracking
  requestId     String?  @map("request_id") // Request ID for correlation
  timestamp     DateTime @default(now())
  success       Boolean  @default(true) // Whether the action was successful
  errorMessage  String?  @map("error_message") // Error message if action failed

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Performance indexes
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([resourceId])
  @@index([timestamp])
  @@index([success])
  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([resourceType, timestamp])
  @@index([userId, action, timestamp])
  @@index([resourceType, resourceId])
  @@index([requestId])

  @@map("audit_logs")
}

// Guild settings (migrated from MySQL guild_settings table)
model GuildSettings {
  id                  String   @id @default(cuid())
  guildId             String   @unique @map("guild_id")
  sheetId             String?  @map("sheet_id")      // Google Sheets ID for stats
  sheetTab            String?  @map("sheet_tab")     // Specific tab in the sheet
  viewMode            String   @default("baseline")  @map("view_mode")  // 'baseline' or 'latest'
  allowPublic         Boolean  @default(false)       @map("allow_public")    // Public access
  screenshotChannelId String?  @map("screenshot_channel_id")  // Discord channel for screenshots
  uploadsEnabled      Boolean  @default(true)        @map("uploads_enabled")
  notes               String?  // Custom notes/metadata
  updatedAt           DateTime @updatedAt            @map("updated_at")

  // Relations
  guild Guild? @relation(fields: [guildId], references: [discordId], onDelete: Cascade)

  // Performance indexes
  @@index([guildId])
  @@index([updatedAt])

  @@map("guild_settings")
}

// Guild AI personality/persona settings
model GuildPersonality {
  id           String   @id @default(cuid())
  guildId      String   @unique @map("guild_id")
  systemPrompt String   @map("system_prompt")  // System prompt for the AI
  temperature  Float    @default(0.7)          // AI temperature (0-2)
  topP         Float    @default(1.0)          @map("top_p")  // Top P sampling
  tone         String   @default("neutral")    // Bot tone/personality
  updatedAt    DateTime @updatedAt             @map("updated_at")

  // Relations
  guild Guild? @relation(fields: [guildId], references: [discordId], onDelete: Cascade)

  // Performance indexes
  @@index([guildId])
  @@index([updatedAt])

  @@map("guild_personalities")
}

// Club analytics corrections (manual overrides)
model Correction {
  id         String   @id @default(cuid())
  guildId    String   @map("guild_id")        // Guild this correction applies to
  weekId     String   @map("week_id")         // Week identifier
  memberKey  String   @map("member_key")      // Member identifier
  metric     String                            // Metric name being corrected
  value      Json                              // Corrected value
  reason     String?                           // Reason for correction
  createdBy  String?  @map("created_by")     // User who created the correction
  createdAt  DateTime @default(now())         @map("created_at")
  updatedAt  DateTime @updatedAt              @map("updated_at")

  // Performance indexes
  @@index([guildId])
  @@index([weekId])
  @@index([memberKey])
  @@index([metric])
  @@index([createdAt])
  @@index([guildId, weekId])
  @@index([guildId, memberKey])

  @@unique([guildId, weekId, memberKey, metric])
  @@map("corrections")
}

// Webhook configurations for outbound integrations
model Webhook {
  id         Int      @id @default(autoincrement())
  guildId    String   @map("guild_id")
  name       String
  targetUrl  String   @map("target_url")
  secret     String?  // for HMAC signatures
  enabled    Boolean  @default(true)
  eventTypes String   @map("event_types") // comma-separated e.g. "CLUB_SNAPSHOT_CREATED,SEASON_CLOSED"
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  deliveries WebhookDelivery[]

  // Performance indexes
  @@index([guildId])
  @@index([enabled])
  @@index([guildId, enabled])
  @@index([createdAt])

  @@map("webhooks")
}

// Webhook delivery logs for tracking and debugging
model WebhookDelivery {
  id           Int      @id @default(autoincrement())
  webhookId    Int      @map("webhook_id")
  eventType    String   @map("event_type")
  payload      Json
  status       String   // 'success', 'failed', 'retrying'
  responseCode Int?     @map("response_code")
  errorMessage String?  @map("error_message")
  retryCount   Int      @default(0) @map("retry_count")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([createdAt])
  @@index([webhookId, createdAt])
  @@index([status, createdAt])

  @@map("webhook_deliveries")
}
